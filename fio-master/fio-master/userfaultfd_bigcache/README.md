# BigCache + Userfaultfd å†·å¯åŠ¨ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†ä¸€ç§åˆ›æ–°çš„ Android åº”ç”¨å†·å¯åŠ¨ä¼˜åŒ–æ–¹æ¡ˆï¼Œé€šè¿‡å°†å¤šä¸ªæ–‡ä»¶çš„çƒ­ç‚¹é¡µï¼ˆHot Pagesï¼‰æ‰“åŒ…æˆå•ä¸€é¡ºåºæ–‡ä»¶ï¼Œé…åˆ Linux userfaultfd æœºåˆ¶å®ç°"å·æ¢æ¢æŸ±"å¼çš„æ•°æ®ä¾›ç»™ï¼Œå°†éšæœº I/O è½¬æ¢ä¸ºé¡ºåº I/Oã€‚

### æ ¸å¿ƒåˆ›æ–°ç‚¹

```
ä¼ ç»Ÿ Prefetch: æˆ‘è¦è¯»Aï¼Œæ‰€ä»¥æˆ‘æå‰è¯»A
æˆ‘ä»¬çš„åˆ›æ–°: ç³»ç»Ÿä»¥ä¸ºå®ƒåœ¨è¯»Aã€Bã€Cï¼ˆéšæœºIOï¼‰ï¼Œä½†æˆ‘å®é™…ä¸Šåªè¯»äº†å¤§æ–‡ä»¶Dï¼ˆé¡ºåºIOï¼‰
```

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Application                               â”‚
â”‚                  (è®¤ä¸ºè‡ªå·±åœ¨è¯» liba.so, libb.so...)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ page fault
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Userfaultfd Handler                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Page Fault  â”‚â†’ â”‚ Lookup in   â”‚â†’ â”‚ Copy from BigCache       â”‚ â”‚
â”‚  â”‚  Handler    â”‚  â”‚ Index Table â”‚  â”‚ Buffer to Fault Address  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†‘
                              â”‚ pre-loaded (sequential read)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BigCache.bin                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”           â”‚
â”‚  â”‚P1  â”‚P2  â”‚P3  â”‚P4  â”‚P5  â”‚P6  â”‚P7  â”‚P8  â”‚...â”‚Pn  â”‚           â”‚
â”‚  â”‚4KB â”‚4KB â”‚4KB â”‚4KB â”‚4KB â”‚4KB â”‚4KB â”‚4KB â”‚   â”‚4KB â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜           â”‚
â”‚  (çƒ­ç‚¹é¡µæŒ‰è®¿é—®é¡ºåºç´§å¯†æ’åˆ—)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
userfaultfd_bigcache/
â”œâ”€â”€ README.md                    # æœ¬æ–‡æ¡£
â”œâ”€â”€ include/
â”‚   â”œâ”€â”€ bigcache.h              # BigCache æ ¸å¿ƒæ•°æ®ç»“æ„
â”‚   â””â”€â”€ uffd_handler.h          # Userfaultfd å¤„ç†å™¨å¤´æ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ bigcache_packer.c       # BigCache æ‰“åŒ…å·¥å…·
â”‚   â”œâ”€â”€ bigcache_index.c        # ç´¢å¼•è¡¨ç®¡ç†
â”‚   â”œâ”€â”€ uffd_handler.c          # Userfaultfd å¤„ç†å™¨
â”‚   â”œâ”€â”€ preloader.c             # é¢„åŠ è½½å™¨
â”‚   â””â”€â”€ main.c                  # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ generate_bigcache.py    # ä» trace æ•°æ®ç”Ÿæˆ BigCache
â”‚   â””â”€â”€ verify_bigcache.py      # éªŒè¯ BigCache å®Œæ•´æ€§
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ test_simulation.c       # æ¨¡æ‹Ÿæµ‹è¯•
â”‚   â”œâ”€â”€ benchmark.c             # æ€§èƒ½åŸºå‡†æµ‹è¯•
â”‚   â””â”€â”€ test_runner.py          # æµ‹è¯•è¿è¡Œå™¨
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ build_android.sh        # Android NDK ç¼–è¯‘è„šæœ¬
â”‚   â”œâ”€â”€ deploy_to_device.sh     # éƒ¨ç½²åˆ°è®¾å¤‡
â”‚   â””â”€â”€ run_benchmark.sh        # è¿è¡ŒåŸºå‡†æµ‹è¯•
â”œâ”€â”€ Makefile                    # ä¸» Makefile
â””â”€â”€ Android.mk                  # Android NDK Makefile
```

## ğŸ”§ ç¼–è¯‘ä¸ä½¿ç”¨

### Linux ç¯å¢ƒæµ‹è¯•
```bash
make clean && make
./test/test_simulation
./test/benchmark
```

### Android è®¾å¤‡éƒ¨ç½²
```bash
# éœ€è¦ root æƒé™å’Œ NDK
./scripts/build_android.sh
./scripts/deploy_to_device.sh
./scripts/run_benchmark.sh
```

## ğŸ“Š é¢„æœŸæ€§èƒ½æå‡

æ ¹æ®å¯¹å“”å“©å“”å“© APP å†·å¯åŠ¨ IO çš„åˆ†æï¼š

| æŒ‡æ ‡ | å½“å‰æ¨¡å¼ | BigCache æ¨¡å¼ | æå‡ |
|------|----------|---------------|------|
| IO æ¬¡æ•° | ~48,000 | 1 | ~48,000x |
| æ–‡ä»¶åˆ‡æ¢ | ~12,000 | 0 | æ¶ˆé™¤ |
| Seek æ¬¡æ•° | ~12,000 | 1 | ~12,000x |
| ç†è®ºè¯»å–æ—¶é—´ | ~6.5s | ~0.65s | ~10x |

## âš ï¸ é™åˆ¶ä¸æ³¨æ„äº‹é¡¹

1. **éœ€è¦ root æƒé™**: userfaultfd éœ€è¦ç‰¹æƒæ“ä½œ
2. **å†…æ ¸ç‰ˆæœ¬**: éœ€è¦ Linux 4.3+ / Android 7.0+
3. **å†…å­˜å¼€é”€**: BigCache éœ€è¦é¢„åŠ è½½åˆ°å†…å­˜
4. **ç»´æŠ¤æˆæœ¬**: åº”ç”¨æ›´æ–°åéœ€è¦é‡æ–°ç”Ÿæˆ BigCache

## ğŸ“š ç›¸å…³æŠ€æœ¯

- [userfaultfd(2)](https://man7.org/linux/man-pages/man2/userfaultfd.2.html)
- [UFFDIO_COPY](https://www.kernel.org/doc/html/latest/admin-guide/mm/userfaultfd.html)
- Android Prefetch æœºåˆ¶
